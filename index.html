<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B√°o C√°o SXKD - ƒê·ªôi QLƒêLKV Than Uy√™n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ChartJS & Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- Excel processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* 1. C·∫•u h√¨nh Font ch·ªØ Times New Roman cho to√†n b·ªô trang */
    body { 
        font-family: "Times New Roman", Times, serif; 
        background: #f3f4f6; 
        color: #000; 
        font-size: 13pt; /* K√≠ch th∆∞·ªõc chu·∫©n vƒÉn b·∫£n */
    }
    
    .card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 16px; }
    
    /* Style b·∫£ng b√°o c√°o cho ƒë·∫πp v√† khi in ra */
    .report-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; margin-bottom: 10px; }
    .report-table th { background-color: #e5e7eb; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000; }
    .report-table td { border: 1px solid #000; padding: 5px; vertical-align: middle; }
    
    /* ƒê·ªãnh d·∫°ng ti√™u ƒë·ªÅ */
    h1, h2, h3, h4 { font-weight: bold; color: #003366; margin-bottom: 0.5em; }
    h1 { font-size: 18pt; text-transform: uppercase; }
    h2 { font-size: 14pt; }
    h3 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 5px; margin-top: 20px;}
    
    .hidden-print { display: block; }

    /* C·∫•u h√¨nh khi in (Xu·∫•t PDF) */
    @media print { 
        .hidden-print { display: none !important; } 
        body { background: white; padding: 0; }
        .card { box-shadow: none; border: none; padding: 0; margin-bottom: 20px; }
        /* ƒê·∫£m b·∫£o in m√†u n·ªÅn c·ªßa bi·ªÉu ƒë·ªì/b·∫£ng */
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact;
        /* Ng·∫Øt trang h·ª£p l√Ω */
        section { break-inside: avoid; }
    }
  </style>
</head>
<body class="p-4 md:p-8">

  <div class="max-w-7xl mx-auto">
    <!-- HEADER: S·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o Word -->
    <div class="card flex justify-between items-start bg-white" id="report-header">
      <div style="text-align: left;">
        <h2 style="font-size: 12pt; font-weight: bold; margin: 0;">C√îNG TY ƒêI·ªÜN L·ª∞C LAI CH√ÇU</h2>
        <h1 style="font-size: 14pt; font-weight: bold; color: #003366; margin: 5px 0;">ƒê·ªòI QLƒêLKV THAN UY√äN</h1>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 16pt; font-weight: 900; color: #003366;">B√ÅO C√ÅO S·∫¢N XU·∫§T KINH DOANH</div>
        <div style="font-size: 14pt; font-weight: bold; color: #cc0000; margin-top: 5px;" id="display-period">Th√°ng -- NƒÉm ----</div>
      </div>
    </div>

    <!-- CONTROLS AREA -->
    <div class="card hidden-print space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- File Uploads -->
        <div class="space-y-2">
          <p class="font-bold text-sm text-gray-700">1. N·∫°p d·ªØ li·ªáu ƒë·∫ßu v√†o:</p>
          <div class="flex flex-wrap gap-2">
            <input type="file" id="f-bc" accept=".xlsx,.xls" hidden />
            <button onclick="document.getElementById('f-bc').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm transition font-bold">
              üìÇ 1. Upload Baocao_tonghop
            </button>

            <input type="file" id="f-bckd" accept=".xlsx,.xls" hidden />
            <button onclick="document.getElementById('f-bckd').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm transition font-bold">
              üìÇ 2. Upload BCKD_Thang
            </button>
            
            <input type="file" id="f-ecp" accept=".xlsx,.xls" hidden />
            <button onclick="document.getElementById('f-ecp').click()" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded text-sm transition font-bold">
              üìÇ 3. Upload ECP
            </button>
          </div>
          <div id="file-status" class="text-xs text-gray-500 italic mt-1">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn.</div>
        </div>

        <!-- Month/Year Selection -->
        <div class="space-y-2 border-l pl-4 border-gray-200">
          <p class="font-bold text-sm text-gray-700">2. Ch·ªçn k·ª≥ b√°o c√°o (Quan tr·ªçng):</p>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-1">
              <span class="text-sm">Th√°ng:</span>
              <select id="sel-month" class="border rounded p-1.5 bg-gray-50 font-bold text-blue-800"></select>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-sm">NƒÉm:</span>
              <select id="sel-year" class="border rounded p-1.5 bg-gray-50 font-bold text-blue-800"></select>
            </div>
            <button id="btn-apply-period" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded text-sm font-bold shadow-sm">
              √ÅP D·ª§NG
            </button>
          </div>
          <p class="text-xs text-gray-500">Ch·ªçn th·ªùi gian ƒë·ªÉ l·ªçc d·ªØ li·ªáu KPI v√† S·ª± c·ªë t·ª´ file t·ªïng h·ª£p.</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-2 border-t pt-4 mt-2">
        <button id="btn-manual" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 text-sm">Nh·∫≠p tay s·ªë li·ªáu </button>
        <div class="flex-grow"></div>
        <button id="btn-gen" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold shadow text-sm">
          T·∫†O B√ÅO C√ÅO
        </button>
        <button id="btn-export-word" class="bg-blue-800 hover:bg-blue-900 text-white px-4 py-2 rounded text-sm font-bold">
          Xu·∫•t file Word
        </button>
        <!-- Thay th·∫ø n√∫t Powerpoint b·∫±ng n√∫t Xu·∫•t PDF/·∫¢nh (Presentation) -->
        <button id="btn-export-ppt" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm font-bold" title="S·ª≠ d·ª•ng ch·ª©c nƒÉng In c·ªßa tr√¨nh duy·ªát ƒë·ªÉ t·∫°o PDF ho·∫∑c ·∫£nh ch·∫•t l∆∞·ª£ng cao ƒë·ªÉ tr√¨nh b√†y">
          Xu·∫•t PDF/·∫¢nh (Presentation)
        </button>
        <button id="btn-export-pdf" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded text-sm font-bold" title="K√≠ch ho·∫°t h·ªôp tho·∫°i In/L∆∞u PDF c·ªßa tr√¨nh duy·ªát">
          In / L∆∞u PDF
        </button>
      </div>
    </div>

    <!-- MANUAL INPUT SECTION -->
    <div id="manual-area" class="card hidden hidden-print">
      <h3 class="font-bold text-gray-700 mb-2">Nh·∫≠p tay chi·ªÅu d√†i/ti·∫øt di·ªán d√¢y (ƒê∆°n v·ªã: km):</h3>
      <!-- B·ªï sung th√™m ƒê∆∞·ªùng d√¢y h·∫° th·∫ø -->
      <!-- T·ªïng chi·ªÅu d√†i s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n l·∫°i trong JS (Ch·ªâ t√≠nh trung th·∫ø) -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <input id="m-total" placeholder="T·ªïng chi·ªÅu d√†i TT (km)" class="border p-2 rounded text-sm" value="">
        <input id="m-371" placeholder="371 E29.2 (km)" class="border p-2 rounded text-sm" value="64.61">
        <input id="m-373" placeholder="373 E29.2 (km)" class="border p-2 rounded text-sm" value="70.23">
        <input id="m-375" placeholder="375 E29.2 (km)" class="border p-2 rounded text-sm" value="37.82">
        <input id="m-376" placeholder="376 E29.2 (km)" class="border p-2 rounded text-sm" value="40.23">
        <input id="m-377" placeholder="377 E29.2 (km)" class="border p-2 rounded text-sm" value="71.77">
	<input id="m-378" placeholder="378 E29.2 (km)" class="border p-2 rounded text-sm" value="31.72">
        <input id="m-lt-day" placeholder="ƒê∆∞·ªùng d√¢y h·∫° th·∫ø (km)" class="border p-2 rounded text-sm" value="667.40 ">
    	<input id="m-recloser" placeholder="M√°y c·∫Øt Recloser (b·ªô)" class="border p-2 rounded text-sm" value="06 ">
    	<input id="m-lbs" placeholder="LBS (b·ªô)" class="border p-2 rounded text-sm" value="13 ">
    	<input id="m-tubutt" placeholder="T·ª• b√π trung th·∫ø (b·ªô)" class="border p-2 rounded text-sm" value="04 ">
    	<input id="m-tbuht" placeholder="T·ª• b√π h·∫° th·∫ø (b·ªô)" class="border p-2 rounded text-sm" value="297 ">
      </div>
      <textarea id="m-other" class="w-full border p-2 rounded mt-3 text-sm" placeholder="Nh·∫≠p n·ªôi dung m·ª•c 6 (C√¥ng t√°c kh√°c)..."></textarea>
<div class="mt-6">
  <h3 class="font-bold text-gray-700 mb-2">üì∏ ·∫¢nh minh h·ªça cho M·ª•c 6:</h3>

  <input type="file" id="manual-images" accept="image/*" multiple hidden>
  <button onclick="document.getElementById('manual-images').click()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
      ‚ûï T·∫£i ·∫£nh
  </button>

  <!-- Hi·ªÉn th·ªã danh s√°ch ·∫£nh -->
  <div id="manual-image-preview"
       class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
  </div>
</div>
    </div>

    <!-- REPORT CONTENT AREA -->
    <div id="report-content" class="min-h-screen hidden bg-white p-4">
      
      <!-- 1. QU·∫¢N TR·ªä -->
      <section class="mb-8">
        <h3>1. C√îNG T√ÅC QU·∫¢N TR·ªä</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="h-64 border p-2"><canvas id="c-age"></canvas></div>
          <div class="h-64 border p-2"><canvas id="c-dept"></canvas></div>
          <div class="h-64 border p-2"><canvas id="c-qual"></canvas></div>
        </div>
      </section>

      <!-- 2. KINH DOANH -->
      <section class="mb-8">
        <h3>2. C√îNG T√ÅC KINH DOANH & DVKH</h3>
        <div id="bckd-table-area" class="overflow-x-auto mb-4"></div>
      </section>

      <!-- 3. K·ª∏ THU·∫¨T -->
      <section class="mb-8">
        <h3>3. C√îNG T√ÅC QU·∫¢N L√ù K·ª∏ THU·∫¨T</h3>
        
        <!-- 3.1 TBA -->
        <div class="mb-6">
          <h4 class="font-bold text-black mb-2">3.1. S·ªë li·ªáu Tr·∫°m bi·∫øn √°p (T·ªïng h·ª£p theo ƒë∆∞·ªùng d√¢y)</h4>
          <div id="tba-summary-area" class="overflow-x-auto"></div>
        </div>

        <!-- 3.2 D√¢y -->
        <div class="mb-6">
          <h4 class="font-bold text-black mb-2">3.2. T·ªïng chi·ªÅu d√†i ƒë∆∞·ªùng d√¢y trung th·∫ø</h4>
          <div id="wire-summary" class="bg-gray-50 p-3 border text-sm"></div>
        </div>

        <!-- 3.3 S·ª± c·ªë -->
        <div>
  <h4 class="font-bold text-black mb-2">3.3. T√¨nh h√¨nh s·ª± c·ªë</h4>

  <!-- Bi·ªÉu ƒë·ªì th√°ng -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="h-64 border p-2"><canvas id="c-inc-type"></canvas></div>
    <div class="h-64 border p-2"><canvas id="c-inc-nature"></canvas></div>
  </div>

  <!-- √î l≈©y k·∫ø -->
  <div id="incident-cumulative-box" class="p-3 mb-4 bg-yellow-100 border border-yellow-500 text-black font-bold text-center">
      L≈©y k·∫ø s·ª± c·ªë: <span id="incident-cum-value">0</span> v·ª•
  </div>

  <!-- Bi·ªÉu ƒë·ªì l≈©y k·∫ø -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="h-64 border p-2"><canvas id="c-inc-type-cum"></canvas></div>
      <div class="h-64 border p-2"><canvas id="c-inc-nature-cum"></canvas></div>
  </div>

  <div id="incident-list-area"></div>
</div>
      </section>
	
	<!-- 3.4 B√ÅO C√ÅO T·ªîN TH·∫§T -->
<div class="mb-6">
  <h4 class="font-bold text-black mb-2">3.4. B√°o c√°o t·ªïn th·∫•t</h4>

  <!-- 3.4.1 -->
  <h5 class="font-bold text-blue-700">3.4.1. T·ªïn th·∫•t ƒë∆°n v·ªã k·ª≥ th∆∞∆°ng ph·∫©m</h5>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="h-64 border p-2"><canvas id="loss-ky"></canvas></div>
    <div class="h-64 border p-2"><canvas id="loss-ky-cum"></canvas></div>
  </div>

  <!-- 3.4.2 -->
  <h5 class="font-bold text-blue-700">3.4.2. T·ªïn th·∫•t ƒë∆°n v·ªã c·∫•p ƒëi·ªán √°p</h5>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="h-64 border p-2"><canvas id="loss-cap"></canvas></div>
    <div class="h-64 border p-2"><canvas id="loss-cap-cum"></canvas></div>
  </div>

  <!-- 3.4.3 -->
  <h5 class="font-bold text-blue-700">3.4.3. T·ªïn th·∫•t trung √°p</h5>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="h-64 border p-2"><canvas id="loss-mid"></canvas></div>
    <div class="h-64 border p-2"><canvas id="loss-mid-cum"></canvas></div>
  </div>

  <!-- 3.4.4 -->
  <h5 class="font-bold text-blue-700">3.4.4. T·ªïn th·∫•t h·∫° √°p</h5>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="h-64 border p-2"><canvas id="loss-low"></canvas></div>
    <div class="h-64 border p-2"><canvas id="loss-low-cum"></canvas></div>
  </div>

</div>

      <!-- 4. AN TO√ÄN -->
<section class="mb-8">
  <h3>4. C√îNG T√ÅC AN TO√ÄN (ECP)</h3>

  <!-- H√†ng 1: PLV th√°ng + T·ª∑ l·ªá ho√£n h·ªßy -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="h-64 border p-2"><canvas id="c-ecp1"></canvas></div>
    <div class="h-64 border p-2"><canvas id="c-ecp2"></canvas></div>
  </div>

  <!-- H√†ng 2: PLV l≈©y k·∫ø + L≈©y k·∫ø ho√£n h·ªßy -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="h-64 border p-2"><canvas id="c-ecp3"></canvas></div>
    <div class="h-64 border p-2"><canvas id="c-ecp4"></canvas></div>
  </div>

</section>

      <!-- 5. KPI -->
      <section class="mb-8">
        <h3>5. CH·ªà TI√äU KPI</h3>
        <div class="grid grid-cols-1 gap-6">
            <div>
                <h4 class="font-bold text-sm text-center mb-2">Bi·ªÉu ƒë·ªì 5.1: KPI c√°c ƒë∆°n v·ªã th√°ng b√°o c√°o</h4>
                <div class="h-80 border p-2"><canvas id="c-kpi-all"></canvas></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-bold text-sm text-center mb-2">Bi·ªÉu ƒë·ªì 5.2: L≈©y k·∫ø KPI Than Uy√™n</h4>
                    <div class="h-64 border p-2"><canvas id="c-kpi-cumulative"></canvas></div>
                </div>
                <div>
                    <h4 class="font-bold text-sm text-center mb-2">Bi·ªÉu ƒë·ªì 5.3: So s√°nh c√πng k·ª≥</h4>
                    <div class="h-64 border p-2"><canvas id="c-kpi-yoy"></canvas></div>
                </div>
            </div>
        </div>
        <div id="kpi-debug" class="text-xs text-red-400 mt-2"></div>
      </section>

      <!-- 6. KH√ÅC -->
      <section class="mb-8">
        <h3>6. C√ÅC C√îNG T√ÅC KH√ÅC</h3>
        <div id="other-content" class="text-sm whitespace-pre-line text-gray-700"></div>
      </section>

      <div class="text-right text-sm italic mt-8 pb-8">
        Than Uy√™n, ng√†y <span id="print-date"></span><br>
        <strong>Ng∆∞·ªùi l·∫≠p bi·ªÉu</strong>
      </div>
    </div>
  </div>

<script>
// --- C·∫§U H√åNH CHART JS ---
Chart.register(ChartDataLabels);
Chart.defaults.font.family = "'Times New Roman', serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#000';
Chart.defaults.maintainAspectRatio = false;

// NOTE: We keep a safe default datalabels formatter here, but createChart accepts a forceInteger flag
Chart.defaults.set('plugins.datalabels', {
  display: true,
  color: '#000',
  anchor: 'end',
  align: 'top',
  offset: 2,
  font: { weight: 'bold', size: 10 },
  formatter: (value) => {
    if (value === 0) return '';
    if (value > 1000) return (value / 1000).toFixed(1) + 'k';
    // default (may be overridden by createChart forceInteger)
    return parseFloat(value).toFixed(2).replace(/\.00$/, '').toLocaleString('vi-VN');
  } 
});

// GLOBAL STATE
const state = {
  files: { baocao: null, bckd: null, ecp: null },
  month: new Date().getMonth() + 1,
  year: new Date().getFullYear(),
  charts: [] // some code pushes charts; createChart stores by id to avoid duplicates
};

// Colors for charts with multiple categories
const CHART_COLORS = [
    '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#6366f1', '#ec4899', '#8b5cf6',
    '#06b6d4', '#f97316', '#14b8a6', '#a855f7', '#fb923c', '#d946ef', '#0ea5e9',
    '#e11d48', '#059669', '#ca8a04', '#7c3aed', '#be185d', '#4f46e5', '#22c3e5'
];

// --- KH·ªûI T·∫†O ---
(function init() {
  const selMonth = document.getElementById('sel-month');
  for(let i=1; i<=12; i++) selMonth.add(new Option(i, i));
  selMonth.value = state.month;

  const selYear = document.getElementById('sel-year');
  const curY = new Date().getFullYear();
  const maxYear = 2030;
  for(let i=curY-3; i<=maxYear; i++) selYear.add(new Option(i, i));
  selYear.value = state.year;

  document.getElementById('display-period').innerText = `Th√°ng ${state.month} NƒÉm ${state.year}`;
  document.getElementById('print-date').innerText = new Date().toLocaleDateString('vi-VN');
})();

// --- S·ª∞ KI·ªÜN DOM ---
document.getElementById('btn-apply-period').onclick = () => {
  state.month = parseInt(document.getElementById('sel-month').value);
  state.year = parseInt(document.getElementById('sel-year').value);
  document.getElementById('display-period').innerText = `Th√°ng ${state.month} NƒÉm ${state.year}`;
  const statusEl = document.getElementById('file-status');
  statusEl.innerHTML = `<span class="text-blue-600 font-bold">ƒê√£ ch·ªçn: T${state.month}/${state.year}. Nh·∫•n "T·∫†O B√ÅO C√ÅO".</span>`;
};

document.getElementById('btn-manual').onclick = () => {
  document.getElementById('manual-area').classList.toggle('hidden');
};

document.getElementById('btn-export-ppt').onclick = () => {
    const reportNode = document.getElementById('report-content');
    if (reportNode.classList.contains('hidden')) {
        const genButton = document.getElementById('btn-gen');
        genButton.textContent = 'Vui l√≤ng T·∫†O B√ÅO C√ÅO tr∆∞·ªõc!';
        genButton.classList.add('animate-pulse');
        setTimeout(() => {
            genButton.textContent = 'T·∫†O B√ÅO C√ÅO';
            genButton.classList.remove('animate-pulse');
        }, 3000);
        return;
    }
    window.print();
};


const handleFile = (e, key) => {
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type: 'array', cellDates: false});
    const json = {};
    workbook.SheetNames.forEach(name => {
      json[name] = XLSX.utils.sheet_to_json(workbook.Sheets[name], {header: 1, defval: ''});
    });
    state.files[key] = json;
    updateFileStatus();
  };
  reader.readAsArrayBuffer(f);
};

document.getElementById('f-bc').onchange = (e) => handleFile(e, 'baocao');
document.getElementById('f-bckd').onchange = (e) => handleFile(e, 'bckd');
document.getElementById('f-ecp').onchange = (e) => handleFile(e, 'ecp');

function updateFileStatus() {
  const s = state.files;
  const list = [];
  if(s.baocao) list.push('Baocao_tonghop');
  if(s.bckd) list.push('BCKD_Thang');
  if(s.ecp) list.push('ECP');
  document.getElementById('file-status').innerText = list.length ? "ƒê√£ n·∫°p: " + list.join(', ') : "Ch∆∞a c√≥ file n√†o.";
}

// --- MAIN GENERATE FUNCTION ---
document.getElementById('btn-gen').onclick = () => {
  // Destroy charts stored as array
  state.charts.forEach(c => { try { c.destroy(); } catch(e){} });
  state.charts = [];
  // Destroy charts stored by id (safety)
  Object.keys(state.charts).forEach(k => {
    try { if(state.charts[k] && state.charts[k].destroy) state.charts[k].destroy(); } catch(e){}
  });

  document.getElementById('report-content').classList.remove('hidden');

  renderSection1_HR();
  renderSection2_Business();
  renderSection3_Tech();
  renderSection4_Safety();
  renderSection5_KPI();
  renderSection6_Other();

  document.getElementById('report-content').scrollIntoView({behavior:'smooth'});
};

// --- RENDER SECTION 1 (HR) ---
function renderSection1_HR() {
  const data = state.files.baocao ? (state.files.baocao['CBCNV'] || Object.values(state.files.baocao)[0]) : [];
  if(!data || data.length < 2) return; 
  const rows = data.slice(1);
  const ageStats = {'<30':0, '30-40':0, '40-50':0, '>50':0};
  const qualStats = {};
  const deptStats = {};
  const header = data[0].map(x => String(x).toLowerCase());
  const idxAge = header.findIndex(h => h.includes('ƒë·ªô tu·ªïi')) !== -1 ? header.findIndex(h => h.includes('ƒë·ªô tu·ªïi')) : 16;
  const idxQual = header.findIndex(h => h.includes('tr√¨nh ƒë·ªô') || h.includes('chuy√™n m√¥n')) !== -1 ? header.findIndex(h => h.includes('tr√¨nh ƒë·ªô')) : 8;
  const idxDept = header.findIndex(h => h.includes('b·ªô ph·∫≠n') || h.includes('ƒë∆°n v·ªã')) !== -1 ? header.findIndex(h => h.includes('b·ªô ph·∫≠n')) : 13;

  rows.forEach(r => {
    if(!r[0]) return;
    const age = parseInt(r[idxAge]) || 0;
    if(age > 0) {
      if(age < 30) ageStats['<30']++;
      else if(age <= 40) ageStats['30-40']++;
      else if(age <= 50) ageStats['40-50']++;
      else ageStats['>50']++;
    }
    const q = String(r[idxQual] || 'Kh√°c').trim();
    qualStats[q] = (qualStats[q] || 0) + 1;
    const d = String(r[idxDept] || 'Kh√°c').trim();
    deptStats[d] = (deptStats[d] || 0) + 1;
  });
  // S·ª≠ d·ª•ng createChart v·ªõi m√†u s·∫Øc ri√™ng cho t·ª´ng c·ªôt
  createChart('c-age', 'doughnut', ageStats, 'ƒê·ªô tu·ªïi', true);
  createChart('c-qual', 'bar', qualStats, 'Tr√¨nh ƒë·ªô', true);
  createChart('c-dept', 'bar', deptStats, 'B·ªô ph·∫≠n', true);
}

// --- RENDER SECTION 2 (Business) ---
function renderSection2_Business() {
  const container = document.getElementById('bckd-table-area');
  container.innerHTML = '';
  if(!state.files.bckd) return;
  const sheet = Object.values(state.files.bckd)[0];
  if(!sheet || sheet.length < 2) return;
  const header = ['STT', 'Ch·ªâ ti√™u', 'ƒêVT', 'Th·ª±c hi·ªán', 'L≈©y k·∫ø'];
  let html = '<table class="report-table"><thead><tr>';
  header.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';
  const rawData = sheet.slice(1);
  let sttCounter = 1;
  rawData.forEach((row, index) => {
    if (index === 19 || index === 20) return; 
    if (sttCounter > 25) return;
    const chiTieu = row[1] || '';
    if(!chiTieu) return;
    const dvt = row[2] || '';
    const kh = parseFloat(row[3]) || 0;
    const th = parseFloat(row[4]) || 0;
    html += `<tr><td class="text-center">${sttCounter++}</td><td>${chiTieu}</td><td class="text-center">${dvt}</td><td class="text-right">${kh.toLocaleString('vi-VN')}</td><td class="text-right font-bold">${th.toLocaleString('vi-VN')}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// ========================
// 3.3 B√ÅO C√ÅO T·ªîN TH·∫§T (Loss) - C·∫¨P NH·∫¨T X·ª¨ L√ù GI√Å TR·ªä √ÇM & C√ÇN ƒê·ªêI TR·ª§C Y
// ========================
function renderLossReport() {
    const mapping = [
        { sheet: "T·ªïn th·∫•t ƒë∆°n v·ªã k·ª≥ th∆∞∆°ng ph·∫©m", id: "loss-ky", idCum: "loss-ky-cum" },
        { sheet: "T·ªïn th·∫•t ƒë∆°n v·ªã c·∫•p ƒëi·ªán √°p", id: "loss-cap", idCum: "loss-cap-cum" },
        { sheet: "T·ªïn th·∫•t trung √°p", id: "loss-mid", idCum: "loss-mid-cum" },
        { sheet: "T·ªïn th·∫•t h·∫° √°p", id: "loss-low", idCum: "loss-low-cum" }
    ];

    mapping.forEach(item => {
        const sheet = state.files.baocao[item.sheet];
        if (!sheet || sheet.length < 2) return;
        const rows = sheet.slice(1);
        
        const currentYear = state.year;
        const lastYear = currentYear - 1;

        let curSumC = Array(12).fill(0), curSumD = Array(12).fill(0);
        let lastSumC = Array(12).fill(0), lastSumD = Array(12).fill(0);
        
        let barLabels = [];
        let barValues = [];

        rows.forEach(r => {
            const year = parseInt(r[0]);
            const month = parseInt(r[1]);
            const cVal = parseFloat(r[2]) || 0;
            const dVal = parseFloat(r[3]) || 0;
            const loss = parseFloat(r[4]) || 0;

            if (month === state.month) {
                barLabels.push(year.toString());
                barValues.push(loss);
            }

            if (year === currentYear) {
                curSumC[month - 1] = cVal;
                curSumD[month - 1] = dVal;
            } else if (year === lastYear) {
                lastSumC[month - 1] = cVal;
                lastSumD[month - 1] = dVal;
            }
        });

        let currentYearLine = [];
        let lastYearLine = [];
        let allValues = []; // D√πng ƒë·ªÉ t√≠nh to√°n min/max cho tr·ª•c Y

        for (let i = 0; i < 12; i++) {
            // L≈©y k·∫ø nƒÉm hi·ªán t·∫°i
            let sC_cur = 0, sD_cur = 0;
            for (let j = 0; j <= i; j++) { sC_cur += curSumC[j]; sD_cur += curSumD[j]; }
            let vCur = sC_cur !== 0 ? (sD_cur / sC_cur) * 100 : null;
            currentYearLine.push(vCur);
            if (vCur !== null) allValues.push(vCur);

            // L≈©y k·∫ø nƒÉm tr∆∞·ªõc
            let sC_last = 0, sD_last = 0;
            for (let j = 0; j <= i; j++) { sC_last += lastSumC[j]; sD_last += lastSumD[j]; }
            let vLast = sC_last !== 0 ? (sD_last / sC_last) * 100 : null;
            lastYearLine.push(vLast);
            if (vLast !== null) allValues.push(vLast);
        }

        // T√çNH TO√ÅN THANG ƒêO ƒê·ªÇ ƒê∆Ø·ªúNG LINE N·∫∞M GI·ªÆA (BAO G·ªíM C·∫¢ GI√Å TR·ªä √ÇM)
        let minVal = allValues.length ? Math.min(...allValues) : 0;
        let maxVal = allValues.length ? Math.max(...allValues) : 10;
        
        // T·∫°o kho·∫£ng ƒë·ªám 30% d·∫£i d·ªØ li·ªáu ƒë·ªÉ ƒë∆∞·ªùng line kh√¥ng ch·∫°m bi√™n
        let range = maxVal - minVal;
        let padding = range * 0.3 || 5; 
        let yMin = minVal - padding;
        let yMax = maxVal + padding;

        // V·∫º BI·ªÇU ƒê·ªí C·ªòT
        createChart(item.id, "bar", Object.fromEntries(barLabels.map((y, i) => [y, barValues[i]])), "T·ª∑ l·ªá t·ªïn th·∫•t th√°ng " + state.month, true);

        // V·∫º BI·ªÇU ƒê·ªí LINE
        const lineCtx = document.getElementById(item.idCum).getContext('2d');
        const oldChart = Chart.getChart(item.idCum);
        if (oldChart) oldChart.destroy();

        new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: Array.from({ length: 12 }, (_, i) => `T${i + 1}`),
                datasets: [
                    {
                        label: `L≈©y k·∫ø nƒÉm ${currentYear} (%)`,
                        data: currentYearLine,
                        borderColor: '#ef4444',
                        backgroundColor: '#ef4444',
                        borderWidth: 2,
                        tension: 0.2,
                        datalabels: { 
                            align: 'top', 
                            anchor: 'end', 
                            color: '#000', 
                            font: { weight: 'bold', size: 10 },
                            offset: 4
                        }
                    },
                    {
                        label: `L≈©y k·∫ø c√πng k·ª≥ ${lastYear} (%)`,
                        data: lastYearLine,
                        borderColor: '#2563eb',
                        backgroundColor: '#2563eb',
                        borderWidth: 2,
                        tension: 0.2,
                        datalabels: { 
                            align: 'bottom', 
                            anchor: 'start', 
                            color: '#000', 
                            font: { weight: 'bold', size: 10 },
                            offset: 4
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'bottom' },
                    datalabels: {
                        display: true,
                        formatter: (v) => v !== null ? v.toFixed(2) : ''
                    }
                },
                scales: {
                    y: { 
                        min: yMin, 
                        max: yMax,
                        grid: {
                            color: (context) => (context.tick.value === 0 ? '#000' : '#e5e7eb'), // L√†m ƒë·∫≠m ƒë∆∞·ªùng m·ªëc 0
                            lineWidth: (context) => (context.tick.value === 0 ? 2 : 1)
                        },
                        title: { display: true, text: '%' } 
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    });
}

// 3. K·ª∏ THU·∫¨T
function renderSection3_Tech() {
  renderLossReport();

  // 3.1 TBA (y√™u c·∫ßu: t·ªïng c·ªông)
  const tbaArea = document.getElementById('tba-summary-area');
  tbaArea.innerHTML = '';
  const targetLines = ['371E29.2', '373E29.2', '375E29.2', '376E29.2', '377E29.2', '378E29.2']; 
  const tbaDataSheet = state.files.baocao ? (state.files.baocao['T√™n c√°c TBA'] || state.files.baocao['TBA']) : null;
  
  let totalCount = 0;
  let totalKVA = 0;
  let totalDl = 0;
  let totalKh = 0;

  if(tbaDataSheet) {
    const data = tbaDataSheet;
    const idxLine = 2; const idxCap = 5; const idxOwner = 7;
    const agg = {};
    data.slice(1).forEach(r => {
      const lineName = String(r[idxLine] || '').trim();
      if (!targetLines.includes(lineName)) return; 
      
      const capStr = String(r[idxCap] || '0').toUpperCase().replace('KVA', '').trim();
      const cap = parseFloat(capStr) || 0;
      const owner = String(r[idxOwner] || '').toLowerCase();
      
      if(!agg[lineName]) agg[lineName] = { count: 0, kva: 0, kh: 0, dl: 0 };
      
      agg[lineName].count++; agg[lineName].kva += cap;
      if(owner.includes('kh√°ch h√†ng') || owner.includes('kh')) { agg[lineName].kh++; totalKh++; } else { agg[lineName].dl++; totalDl++; }
      
      totalCount++; 
      totalKVA += cap;
    });

    let html = `<table class="report-table"><thead><tr><th rowspan="2">ƒê∆∞·ªùng d√¢y</th><th colspan="2">T·ªïng c·ªông</th><th colspan="2">T√†i s·∫£n ƒêi·ªán l·ª±c</th><th colspan="2">T√†i s·∫£n Kh√°ch h√†ng</th></tr><tr><th>SL</th><th>kVA</th><th>SL</th><th>%</th><th>SL</th><th>%</th></tr></thead><tbody>`;
    Object.keys(agg).sort().forEach(line => {
      const d = agg[line];
      const pDl = d.count>0?((d.dl/d.count)*100).toFixed(0):0;
      const pKh = d.count>0?((d.kh/d.count)*100).toFixed(0):0;
      html += `<tr>
                  <td class="font-bold">${line}</td>
                  <td class="text-center font-bold">${d.count}</td>
                  <td class="text-right">${d.kva.toLocaleString('vi-VN')}</td>
                  <td class="text-center">${d.dl}</td>
                  <td class="text-center">${pDl}%</td>
                  <td class="text-center">${d.kh}</td>
                  <td class="text-center">${pKh}%</td>
              </tr>`;
    });
    
    const totalPdl = totalCount > 0 ? ((totalDl/totalCount)*100).toFixed(0) : 0;
    const totalPkh = totalCount > 0 ? ((totalKh/totalCount)*100).toFixed(0) : 0; 
    html += `<tr>
                <td class="font-bold bg-gray-200">T·ªîNG C·ªòNG</td>
                <td class="text-center font-bold bg-gray-200">${totalCount}</td>
                <td class="text-right font-bold bg-gray-200">${totalKVA.toLocaleString('vi-VN')}</td>
                <td class="text-center font-bold bg-gray-200">${totalDl}</td>
                <td class="text-center font-bold bg-gray-200">${totalPdl}%</td>
                <td class="text-center font-bold bg-gray-200">${totalKh}</td>
                <td class="text-center font-bold bg-gray-200">${totalPkh}%</td>
            </tr>`;
    
    html += '</tbody></table>';
    tbaArea.innerHTML = html;
  }

  // 3.2 D√¢y
  let totalLengthTT = 0;
  const wireInputsTT = ['m-371','m-373','m-375','m-376','m-377','m-378']; 
  wireInputsTT.forEach(id=>{ totalLengthTT += parseFloat(document.getElementById(id).value)||0; });
  document.getElementById('m-total').value = totalLengthTT.toFixed(1);
  
  document.getElementById('wire-summary').innerHTML = `<ul class="grid grid-cols-2 gap-2">
    <li class="font-bold text-blue-800">T·ªïng chi·ªÅu d√†i ƒë∆∞·ªùng d√¢y trung th·∫ø: ${totalLengthTT.toFixed(1)} km</li>
    <li>371 E29.2: ${document.getElementById('m-371').value} km</li>
    <li>373 E29.2: ${document.getElementById('m-373').value} km</li>
    <li>375 E29.2: ${document.getElementById('m-375').value} km</li>
    <li>376 E29.2: ${document.getElementById('m-376').value} km</li>
    <li>377 E29.2: ${document.getElementById('m-377').value} km</li>
    <li>378 E29.2: ${document.getElementById('m-378').value} km</li>
    <li class="font-bold text-blue-800">ƒê∆∞·ªùng d√¢y h·∫° th·∫ø: ${document.getElementById('m-lt-day').value} km</li> 
    <li class="font-bold text-blue-800">M√°y c·∫Øt Recloser: ${document.getElementById('m-recloser').value} b·ªô</li> 
    <li class="font-bold text-blue-800">LBS: ${document.getElementById('m-lbs').value} b·ªô</li> 
    <li class="font-bold text-blue-800">T·ª• b√π trung th·∫ø: ${document.getElementById('m-tubutt').value} b·ªô</li> 
    <li class="font-bold text-blue-800">T·ª• b√π h·∫° th·∫ø: ${document.getElementById('m-tbuht').value} b·ªô</li>
    </ul>`;

  // 3.3 S·ª± c·ªë
  const incArea = document.getElementById('incident-list-area');
  incArea.innerHTML = '';
  const incData = state.files.baocao ? (state.files.baocao['Qu·∫£n l√Ω s·ª± c·ªë'] || state.files.baocao['S·ª± c·ªë']) : null;
  
  if(incData) {
    // Ch·ªâ s·ªë c·ªôt (A=0...)
    const idxLocation = 2; // C
    const idxReason = 3;   // D
    const idxType = 4;     // E
    const idxDate = 5;     // F
    const idxNature = 8;   // I
    const idxLine = 9;     // J
    const idxMonthYear = 10; // K

    // L·ªçc s·ª± c·ªë trong th√°ng hi·ªán t·∫°i
    const filteredInc = incData.slice(1).filter(r => {
      let d = null;
      const kValue = r[idxMonthYear];
      
      if (kValue) {
          if (typeof kValue === 'string') {
              if (kValue.includes('-')) {
                  const parts = kValue.split('-'); // YYYY-MM-DD
                  if (parts.length === 3) d = new Date(parts[0], parts[1] - 1, parts[2]);
              } else if (kValue.includes('/')) {
                  const parts = kValue.split('/'); // DD/MM/YYYY
                  d = new Date(parts[2], parts[1] - 1, parts[0]);
              }
          } else if (typeof kValue === 'number') {
              d = new Date((kValue - (25567 + 2)) * 86400 * 1000);
          }
      }
      // fallback c·ªôt F
      if (!d && r[idxDate]) {
          const fValue = r[idxDate];
           if (typeof fValue === 'string') {
               const datePart = fValue.substring(0, 10); 
               if(datePart.includes('/')) {
                   const parts = datePart.split('/');
                   d = new Date(parts[2], parts[1]-1, parts[0]);
               }
           } else if (typeof fValue === 'number') {
               d = new Date((fValue - (25567 + 2)) * 86400 * 1000);
           }
      }

      if(d && !isNaN(d.getTime())) {
        return d.getMonth() + 1 === state.month && d.getFullYear() === state.year;
      }
      return false;
    });

    const typeStats = {}; const natureStats = {};
    let html = '<table class="report-table mt-2"><thead><tr><th>STT</th><th>Ng√†y</th><th>ƒê∆∞·ªùng d√¢y</th><th>V·ªã tr√≠/Thi·∫øt b·ªã</th><th>T√≥m t·∫Øt Nguy√™n nh√¢n</th><th>T√≠nh ch·∫•t</th><th>Lo·∫°i s·ª± c·ªë</th></tr></thead><tbody>';
    
    if(filteredInc.length === 0) {
      html += '<tr><td colspan="7" class="text-center italic">Kh√¥ng c√≥ s·ª± c·ªë trong th√°ng.</td></tr>';
    }

    filteredInc.forEach((r, idx) => {
        // Format ng√†y
        let rawDate = r[idxMonthYear] || r[idxDate];
        let dateStr = '---';
        
        let dObj = null;
        if(typeof rawDate === 'number') {
             dObj = new Date((rawDate - (25567 + 2)) * 86400 * 1000);
        } else if (typeof rawDate === 'string') {
             if(rawDate.includes('-')) {
                 const p = rawDate.split('-'); dObj = new Date(p[0], p[1]-1, p[2]);
             } else if(rawDate.includes('/')) {
                 const p = rawDate.split(' ')[0].split('/'); 
                 if(p.length === 3) dObj = new Date(p[2], p[1]-1, p[0]);
             }
        }
        
        if(dObj && !isNaN(dObj.getTime())) {
            dateStr = `${String(dObj.getDate()).padStart(2,'0')}/${String(dObj.getMonth()+1).padStart(2,'0')}/${dObj.getFullYear()}`;
        } else {
            dateStr = String(rawDate).substring(0, 10);
        }

        const location = r[idxLocation] || '';
        const reason = r[idxReason] || '';
        const nature = r[idxNature] || '';
        const line = r[idxLine] || '';
        const type = r[idxType] || '';

        html += `<tr>
            <td class="text-center">${idx + 1}</td>
            <td>${dateStr}</td>
            <td>${line}</td>
            <td>${location}</td>
            <td>${reason}</td>
            <td>${nature}</td>
            <td>${type}</td>
        </tr>`;

        // Chart Data (for monthly charts)
        const t = String(type).trim(); if(t) typeStats[t] = (typeStats[t] || 0) + 1;
        const n = String(nature).trim(); if(n) natureStats[n] = (natureStats[n] || 0) + 1;
    });
    html += '</tbody></table>';
    incArea.innerHTML = html;

    // Monthly charts (existing)
    createChart('c-inc-type', 'pie', typeStats, 'Ph√¢n lo·∫°i', true);
    createChart('c-inc-nature', 'bar', natureStats, 'T√≠nh ch·∫•t', true);

    // =====================
    // T√çNH & V·∫º L≈®Y K·∫æ S·ª∞ C·ªê (ƒê·∫∑t ·ªü ƒë√¢y - trong scope renderSection3_Tech)
    // =====================
    // L≈©y k·∫ø trong nƒÉm (t√≠nh theo th√°ng 1..state.month)
    const cumTypeStats = {};
    const cumNatureStats = {};
    let totalCum = 0;

    // iterate through all rows and count those with year == state.year and month <= state.month
    incData.slice(1).forEach(r => {
        let d = null;
        const kValue = r[idxMonthYear];
        if (kValue) {
            if (typeof kValue === 'number') {
                d = new Date((kValue - (25567 + 2)) * 86400 * 1000);
            } else if (typeof kValue === 'string') {
                if (kValue.includes('-')) {
                    const p = kValue.split('-'); d = new Date(p[0], p[1]-1, p[2]);
                } else if (kValue.includes('/')) {
                    const p = kValue.split('/'); d = new Date(p[2], p[1]-1, p[0]);
                }
            }
        }
        // fallback to idxDate
        if(!d && r[idxDate]) {
            const f = r[idxDate];
            if(typeof f === 'number') {
                d = new Date((f - (25567 + 2)) * 86400 * 1000);
            } else if (typeof f === 'string') {
                if (f.includes('-')) {
                    const p = f.split('-'); d = new Date(p[0], p[1]-1, p[2]);
                } else if (f.includes('/')) {
                    const p = f.split(' ')[0].split('/'); if(p.length===3) d = new Date(p[2], p[1]-1, p[0]);
                }
            }
        }

        if (d && !isNaN(d.getTime())) {
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            if (y === state.year && m <= state.month) {
                totalCum++;
                const t = String(r[idxType] || '').trim(); if(t) cumTypeStats[t] = (cumTypeStats[t] || 0) + 1;
                const n = String(r[idxNature] || '').trim(); if(n) cumNatureStats[n] = (cumNatureStats[n] || 0) + 1;
            }
        }
    });

    // Show total in the yellow box as integer
    const cumBox = document.getElementById('incident-cum-value');
    if (cumBox) cumBox.innerText = totalCum;

    // Create the two cumulative charts (force integer labels)
    createChart('c-inc-type-cum', 'bar', cumTypeStats, 'L≈©y k·∫ø theo ph√¢n lo·∫°i', true, true);
    createChart('c-inc-nature-cum', 'bar', cumNatureStats, 'L≈©y k·∫ø theo t√≠nh ch·∫•t', true, true);

  } else {
    incArea.innerHTML = '<p class="text-red-500">Thi·∫øu sheet "Qu·∫£n l√Ω s·ª± c·ªë".</p>';
  }
}

// 4. AN TO√ÄN (ECP)
function renderSection4_Safety() {

  const year = state.year;
  const month = state.month;

  if (!state.files.ecp) return;

  const sheet = Object.values(state.files.ecp)[0];
  if (!sheet || sheet.length < 2) return;

  const rows = sheet.slice(1).filter(r =>
      Number(r[0]) === year && Number(r[1]) === month
  );

  if (rows.length === 0) return;

  // L·∫•y d·ªØ li·ªáu theo y√™u c·∫ßu
  const plvKH = rows[0][2] || 0;  // C
  const plvBS = rows[0][3] || 0;  // D
  const plvDX = rows[0][4] || 0;  // E
  const hoanHuy = rows[0][5] || 0; // F

  // 1. PLV trong th√°ng
  createChart("c-ecp1", "pie", {
      "K·∫ø ho·∫°ch": plvKH,
      "B·ªï sung": plvBS,
      "ƒê·ªôt xu·∫•t": plvDX
  }, "PLV trong th√°ng", true);

  // 2. T·ª∑ l·ªá ho√£n h·ªßy
  const tongPLV = plvKH + plvBS + plvDX;
  createChart("c-ecp2", "pie", {
      "Ho√£n/H·ªßy": hoanHuy,
      "Th·ª±c hi·ªán": tongPLV - hoanHuy
  }, "T·ª∑ l·ªá ho√£n h·ªßy", true);

  // 3. PLV l≈©y k·∫ø
  const rowsYear = sheet.slice(1).filter(r => Number(r[0]) === year);

  const sumKH = rowsYear.reduce((a,b) => a + (Number(b[2])||0), 0);
  const sumBS = rowsYear.reduce((a,b) => a + (Number(b[3])||0), 0);
  const sumDX = rowsYear.reduce((a,b) => a + (Number(b[4])||0), 0);

  createChart("c-ecp3", "pie", {
      "K·∫ø ho·∫°ch": sumKH,
      "B·ªï sung": sumBS,
      "ƒê·ªôt xu·∫•t": sumDX
  }, "PLV l≈©y k·∫ø", true);

  // 4. L≈©y k·∫ø ho√£n h·ªßy
  const sumHH = rowsYear.reduce((a,b) => a + (Number(b[5])||0), 0);
  const tongLuyKe = sumKH + sumBS + sumDX;

  createChart("c-ecp4", "pie", {
      "Ho√£n/H·ªßy": sumHH,
      "Th·ª±c hi·ªán": tongLuyKe - sumHH
  }, "L≈©y k·∫ø ho√£n h·ªßy", true);

}

// 5. KPI
function renderSection5_KPI() {
  ['c-kpi-all', 'c-kpi-cumulative', 'c-kpi-yoy'].forEach(id => {
    const c = document.getElementById(id); 
    if(c) { const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
  });
  
  if(!state.files.baocao) return;
  const kpiSheetName = Object.keys(state.files.baocao).find(k => k.toUpperCase() === 'KPI');
  if(!kpiSheetName) return;
  const data = state.files.baocao[kpiSheetName];
  if(!data || data.length<2) return;

  const idxYear = 0; const idxMonth = 1; const idxName = 2; const idxVal = 3;

  const targetUnits = [
      "Than Uy√™n", "ƒêo√†n K·∫øt", "T√¢n Uy√™n", "S√¨n H·ªì", "Phong Th·ªï", "N·∫≠m H√†ng", "Bum T·ªü"
  ];

  const currentMonthData = data.slice(1).filter(r => {
    return parseInt(r[idxMonth]) === state.month && parseInt(r[idxYear]) === state.year;
  });

  const kpiDataMap = {};
  targetUnits.forEach(unitName => {
      const row = currentMonthData.find(r => String(r[idxName]).includes(unitName));
      const val = row ? parseFloat(row[idxVal]) : 0;
      kpiDataMap[unitName] = val;
  });
  
  const sortedUnits = Object.entries(kpiDataMap).sort(([,a], [,b]) => b - a);
  const labels1 = sortedUnits.map(([unit]) => unit);
  const values1 = sortedUnits.map(([,value]) => value);
  
  const colors1 = labels1.map((unit, index) => {
      if (unit === 'Than Uy√™n') return '#dc2626';
      return CHART_COLORS[index % CHART_COLORS.length];
  });

  const ctxAll = document.getElementById('c-kpi-all').getContext('2d');
  state.charts.push(new Chart(ctxAll, {
    type: 'bar',
    data: {
      labels: labels1,
      datasets: [{
        label: `KPI T${state.month}/${state.year}`,
        data: values1,
        backgroundColor: colors1,
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'x', 
      plugins: {
        legend: { display: false },
        datalabels: { 
            color: '#000', 
            anchor: 'end', 
            align: 'top', 
            rotation: -90,
            offset: 0
        }
      },
      scales: { 
          y: { 
              beginAtZero: false, 
              min: 80
          },
          x: {
              ticks: { autoSkip: false, maxRotation: 90, minRotation: 90 }
          }
      }
    }
  }));

  // KPI cumulative for Than Uy√™n
  const dhKpi = data.slice(1).filter(r => {
    return parseInt(r[idxYear]) === state.year && String(r[idxName]).includes('Than Uy√™n') && parseInt(r[idxMonth]) <= state.month;
  }).sort((a,b) => parseInt(a[idxMonth]) - parseInt(b[idxMonth]));

  if(dhKpi.length > 0) {
      const cumu = []; let sum = 0;
      for(let i=0; i<dhKpi.length; i++) {
          sum += parseFloat(dhKpi[i][idxVal]) || 0;
          cumu.push(sum / (i+1));
      }
      const ctx2 = document.getElementById('c-kpi-cumulative').getContext('2d');
      state.charts.push(new Chart(ctx2, {
          type: 'line',
          data: {
              labels: dhKpi.map(r => `T${r[idxMonth]}`),
              datasets: [{
                  label: 'L≈©y k·∫ø TB',
                  data: cumu,
                  borderColor: '#10b981',
                  backgroundColor: '#10b981',
                  tension: 0.1
              }]
          },
          options: { scales: { y: { min: 90 } } }
      }));
  }

  const curVal = kpiDataMap['Than Uy√™n'] || 0;
  const lastYear = state.year - 1;
  const lastYearRow = data.slice(1).find(r => parseInt(r[idxMonth])===state.month && parseInt(r[idxYear])===lastYear && String(r[idxName]).includes('Than Uy√™n'));
  const lastVal = lastYearRow ? parseFloat(lastYearRow[idxVal]) : 0;

  const ctx3 = document.getElementById('c-kpi-yoy').getContext('2d');
  state.charts.push(new Chart(ctx3, {
      type: 'bar',
      data: {
          labels: [`${state.month}/${lastYear}`, `${state.month}/${state.year}`],
          datasets: [{
              label: 'ƒêi·ªÉm KPI',
              data: [lastVal, curVal],
              backgroundColor: ['#9ca3af', '#dc2626']
          }]
      },
      options: { scales: { y: { min: 80 } }, plugins: { legend: {display: false} } }
  }));
}

// 6. OTHER
function renderSection6_Other() {
  const text = document.getElementById('m-other').value || "(Ch∆∞a c√≥ n·ªôi dung)";
  let html = `<div class="mb-4 whitespace-pre-line">${text}</div>`;

  if (manualImages.length > 0) {
      html += `<h4 class="font-bold mt-4 mb-2 text-blue-700">üì∑ H√¨nh ·∫£nh minh h·ªça:</h4>`;

      manualImages.forEach((img) => {
          html += `
              <div class="my-4 border p-2 rounded bg-gray-50" style="text-align:${img.align}">
                  <img src="${img.src}"
                       style="width:${img.width}px; border-radius:6px; display:inline-block;" />
                  <div class="mt-1 text-sm italic">${img.caption || "(Kh√¥ng c√≥ m√¥ t·∫£)"}</div>
              </div>
          `;
      });
  }

  document.getElementById('other-content').innerHTML = html;
}
function createChart(id, type, dataObj, title, showValue = true, forceInteger = false) { 
  const ctxEl = document.getElementById(id);
  if (!ctxEl) return;
  // If there is a chart stored under this id, destroy it
  try { if(state.charts[id] && state.charts[id].destroy) state.charts[id].destroy(); } catch(e){}

  const labels = Object.keys(dataObj);
  const values = Object.values(dataObj).map(v => Number(v));

  let backgroundColor;
  if (type === 'pie' || type === 'doughnut') {
    backgroundColor = labels.map((_,i)=>CHART_COLORS[i % CHART_COLORS.length]);
  } else {
    // For bar/line: if multiple labels use colors array, else single color
    if (labels.length > 1) backgroundColor = labels.map((_,i)=>CHART_COLORS[i % CHART_COLORS.length]);
    else backgroundColor = ['#3b82f6'];
  }

  const dataset = {
    label: title,
    data: values,
    backgroundColor,
    borderColor: type === 'line' ? '#3b82f6' : '#2563eb',
    fill: false,
    tension: 0.2,
    borderWidth: 1
  };

  const cfg = {
    type,
    data: { labels, datasets: [dataset] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: title,
          font: { size: 16 }
        },
        legend: {
          position: type === "pie" || type === "doughnut" ? "bottom" : "top"
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const raw = Number(ctx.raw);
              if (forceInteger) {
                return `${ctx.label}: ${Math.round(raw)}`;
              }
              // determine if this is a count distribution (pie/doughnut or c-age/c-dept/c-qual)
              const isCountDistribution = (type === "pie" || type === "doughnut" || id === "c-dept" || id === "c-qual" || id === "c-age");
              if (isCountDistribution) {
                return `${ctx.label}: ${Math.round(raw)}`;
              } else {
                return `${ctx.label}: ${raw.toFixed(2).replace(".",",")}`;
              }
            }
          }
        },
        datalabels: {
          display: showValue,
          color: "#000",
          anchor: type === "pie" || type === "doughnut" ? "center" : (type === "line" ? "center" : "end"),
          align: type === "pie" || type === "doughnut" ? "center" : (type === "line" ? "end" : "top"),
          formatter: function(value, context) {
              const numValue = Number(value);
              if (isNaN(numValue)) return '';
              if (forceInteger) return `${Math.round(numValue)}`;
              const isCountDistribution = (type === "pie" || type === "doughnut" || id === "c-dept" || id === "c-qual" || id === "c-age");
              if (isCountDistribution) {
                  const total = values.reduce((a,b)=>a+b,0);
                  const percent = total ? Math.round((numValue/total)*100) : 0;
                  return `${Math.round(numValue)} (${percent}%)`;
              }
              if (type === 'line' || type === 'bar') {
                return numValue.toFixed(2).replace(".", ",");
              }
              return numValue.toFixed(2).replace(".", ",");
          },
          font: { weight: "bold", size: 11 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          display: type !== "pie" && type !== "doughnut",
          ticks: {
            callback: function(value) {
                if (type === "bar" || type === "line") {
                    // If forceInteger, show integer ticks if values are integer-like
                    if (forceInteger) return `${Math.round(Number(value))}`;
                    return Number(value).toFixed(1).replace(/\.0$/, '').replace(".", ",");
                }
                return value;
            }
          }
        }
      }
    }
  };

  // create and store
  try {
    const chart = new Chart(ctxEl, cfg);
    // store under both array and id for compatibility
    state.charts.push(chart);
    state.charts[id] = chart;
  } catch(e) {
    console.error('createChart error for', id, e);
  }
}

// --- XU·∫§T FILE WORD ---
document.getElementById('btn-export-word').onclick = () => {
    const reportNode = document.getElementById('report-content');
    const headerNode = document.getElementById('report-header'); 

    if (reportNode.classList.contains('hidden')) {
        const genButton = document.getElementById('btn-gen');
        genButton.textContent = 'Vui l√≤ng T·∫†O B√ÅO C√ÅO tr∆∞·ªõc!';
        genButton.classList.add('animate-pulse');
        setTimeout(() => {
            genButton.textContent = 'T·∫†O B√ÅO C√ÅO';
            genButton.classList.remove('animate-pulse');
        }, 3000);
        return;
    }

    const cloneContent = reportNode.cloneNode(true);
    const cloneHeader = headerNode.cloneNode(true); 

    // Convert Canvas to Images in Clone
    const canvases = reportNode.querySelectorAll('canvas');
    const clonedCanvases = cloneContent.querySelectorAll('canvas');

    canvases.forEach((canvas, index) => {
        const imgData = canvas.toDataURL("image/png");
        const img = document.createElement('img');
        img.src = imgData;
        img.style.width = '100%';
        img.style.maxWidth = '600px'; 
        clonedCanvases[index].parentNode.replaceChild(img, clonedCanvases[index]);
    });

    // T·∫°o HTML cho Word, gh√©p Header v√†o tr∆∞·ªõc Content
    const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' 
                          xmlns:w='urn:schemas-microsoft-com:office:word' 
                          xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>B√°o c√°o SXKD</title>
        <style>
            body { font-family: 'Times New Roman', serif; font-size: 13pt; }
            table { border-collapse: collapse; width: 100%; margin-bottom: 10px; }
            td, th { border: 1px solid black; padding: 5px; }
            h1 { font-size: 16pt; text-align: center; color: #003366; text-transform: uppercase; }
            h2 { font-size: 14pt; }
            h3 { font-size: 14pt; color: #003366; margin-top: 15px; border-bottom: 1px solid #000; }
            .text-center { text-align: center; }
            .text-right { text-align: right; }
        </style>
        </head><body>`;
    
    const sourceHTML = header + cloneHeader.innerHTML + "<br><hr><br>" + cloneContent.innerHTML + "</body></html>";

    const blob = new Blob(['\ufeff', sourceHTML], {
        type: 'application/msword'
    });
    
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `BaoCao_SXKD_T${state.month}_${state.year}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// XU·∫§T PDF
document.getElementById('btn-export-pdf').onclick = () => {
    window.print();
};  // <-- ƒë√≥ng h√†m v√† ƒë√≥ng d·∫•u } ƒë·∫ßy ƒë·ªß

// ====== QU·∫¢N L√ù ·∫¢NH & M√î T·∫¢ M·ª§C 6 ======
// ====== QU·∫¢N L√ù ·∫¢NH & M√î T·∫¢ M·ª§C 6 ======
let manualImages = []; // [{src, caption, align, width}]

document.getElementById("manual-images").addEventListener("change", function (e) {
    const files = Array.from(e.target.files);

    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(evt) {
            manualImages.push({
                src: evt.target.result,
                caption: "",
                align: "center",
                width: 400
            });
            renderManualImages();
        };
        reader.readAsDataURL(file);
    });

    e.target.value = "";
});

function renderManualImages() {
    const box = document.getElementById("manual-image-preview");
    box.innerHTML = "";

    manualImages.forEach((obj, index) => {
        const div = document.createElement("div");
        div.className = "border rounded p-2 bg-white shadow";

        div.innerHTML = `
            <img src="${obj.src}"
                 style="width:${obj.width}px; display:block; margin:auto;">

            <textarea 
                class="w-full border rounded p-1 mt-2 text-sm"
                placeholder="Nh·∫≠p m√¥ t·∫£ ·∫£nh..."
                oninput="updateManualCaption(${index}, this.value)"
            >${obj.caption}</textarea>

            <div class="flex items-center gap-1 mt-2 text-xs">
                <button onclick="updateImageAlign(${index}, 'left')" class="px-2 py-1 bg-gray-200 rounded">‚¨ÖÔ∏è Tr√°i</button>
                <button onclick="updateImageAlign(${index}, 'center')" class="px-2 py-1 bg-gray-200 rounded">üî≥ Gi·ªØa</button>
                <button onclick="updateImageAlign(${index}, 'right')" class="px-2 py-1 bg-gray-200 rounded">‚û°Ô∏è Ph·∫£i</button>
            </div>

            <label class="text-xs mt-2 block">K√≠ch th∆∞·ªõc (px):</label>
            <input type="number" min="100" max="1200"
                   value="${obj.width}"
                   oninput="updateImageWidth(${index}, this.value)"
                   class="w-full border rounded px-1 py-1 text-sm mt-1"/>

            <button onclick="deleteManualImage(${index})"
                class="mt-2 bg-red-600 hover:bg-red-700 text-white w-full py-1 text-xs rounded">
                X√≥a ·∫£nh
            </button>
        `;

        box.appendChild(div);
    });
}

function updateManualCaption(i, text) {
    manualImages[i].caption = text;
}

function updateImageAlign(i, align) {
    manualImages[i].align = align;
    renderManualImages();
}

function updateImageWidth(i, width) {
    manualImages[i].width = Number(width);
    renderManualImages();
}

function deleteManualImage(i) {
    manualImages.splice(i, 1);
    renderManualImages();
}
</script>
</body>
</html>
